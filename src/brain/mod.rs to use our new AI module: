// src/brain/mod.rs
mod cloud_ai; // Add this line to declare the new module

use crate::config::AxiomConfig;
use crate::context::EnvironmentContext;
use crate::core::executor;
use serde_json; // Add this to your Cargo.toml if not already there

pub async fn process_command(
    command_str: &str,
    context: &EnvironmentContext,
    config: &AxiomConfig,
) -> anyhow::Result<()> {
    println!("Axiom is thinking... ðŸ¤”");

    // If the user has configured an API key, use the AI.
    if config.ai.openai_api_key.is_some() && config.ai.cloud_fallback {
        println!("(Using AI Brain)");
        // Convert the context to a string for the prompt
        let context_string = serde_json::to_string_pretty(&context)?;
        
        // Get the command from the AI
        let ai_command = cloud_ai::process_with_cloud_ai(command_str, &context_string, &config.ai).await?;
        
        println!("AI suggests this command: {}", ai_command);
        println!("Executing...");

        // Execute the AI-suggested command
        // Note: For security, you might want to confirm with the user first!
        let output = executor::execute_shell_command("sh", &["-c", &ai_command], context)?;
        println!("{}", output);

    } else {
        // Fall back to the simple rule-based logic
        println!("(Using Rule-Based Brain)");
        let command = command_str.to_lowercase();
        
        if command.contains("find file") || command.contains("look for file") {
            println!("I'll help you find a file.");
            let find_output = executor::execute_shell_command("find", &[".", "-name", "*.rs"], context)?;
            println!("Found Rust files:\n{}", find_output);
        } 
        // ... (keep the rest of your existing rule-based code here) 
        else {
            println!("I'm still learning. I heard you say: '{}'", command_str);
            println!("Let me show you what I *do* know about your environment:");
            println!("You are in: {}", context.current_dir_str);
            println!("OS: {}", context.os);
            println!("Project type: {:?}", context.project_type);
            println!("Git branch: {:?}", context.git_branch);
        }
    }

    Ok(())
}